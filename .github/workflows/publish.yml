name: Publish to pub.dev

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # Matches version tags like v1.0.0, v2.1.0-beta
  workflow_dispatch:  # Allow manual triggering

jobs:
  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    # Only run on main branch or tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Check publish readiness
        run: flutter pub publish --dry-run

      - name: Setup pub credentials
        run: |
          mkdir -p $HOME/.config/dart
          cat <<EOF > $HOME/.config/dart/pub-credentials.json
          {
            "accessToken": "${{ secrets.PUB_DEV_ACCESS_TOKEN }}",
            "refreshToken": "${{ secrets.PUB_DEV_REFRESH_TOKEN }}",
            "tokenEndpoint": "https://accounts.google.com/o/oauth2/token",
            "scopes": ["openid", "https://www.googleapis.com/auth/userinfo.email"],
            "expiration": 1999999999999
          }
          EOF

      - name: Publish to pub.dev
        run: flutter pub publish --force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          draft: false
          prerelease: contains(github.ref, '-')
          files: |
            CHANGELOG.md
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        if: success()
        run: |
          echo "üéâ Successfully published flutter_declarative_popups to pub.dev!"
          echo "üì¶ Version: ${GITHUB_REF#refs/tags/}"

      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Failed to publish package"
          exit 1
